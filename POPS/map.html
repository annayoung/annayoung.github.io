
<!DOCTYPE html>
<html>
  <head>
     <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
     <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
     <link href='iframe_style.css' rel='stylesheet' type='text/css'>
     <script type="text/javascript" src="jquery.js"></script>
     <script type="text/javascript" src="slide.js"></script>
     <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script> 
  </head>

  <body>
    
    <div id="map"></div>
    <div id="tool-tip"></div>
    <div id="legends">   
      
      <div id="legend_countries" class="legend">
        <p class="legend_title">POPS</p>
        <span class="left">0</span>
        <span class="right">24</span><br>
        <aside class="colors">
          <div style="background-color:#8C021F;"></div>
          <div style="background-color:#B10026;"></div>
          <div style="background-color:#E31A1C;"></div>
          <div style="background-color:#FC4E2A;"></div>
          <div style="background-color:#FD8D3C;"></div>
          <div style="background-color:#FEB24C;"></div>
          <div style="background-color:#FED976;"></div>
        </aside>
      </div>
    </div>

    <div id="slide_out_info">
      <a class="handle" href="#">
        <span id="rotated_text">Map Info</span>
      </a>
      <div class="content">
        <div class="text">
        <h1>Air pollution trends in countries and cities</h1> <br>
          In 2012, the <a href="http://www.who.int/mediacentre/news/releases/2014/air-pollution/en/" target="_blank">World Health Organization (WHO)</a> estimates 7 million people died - one in eight deaths - due to air pollution exposure. This map shows both national and city-level exposures to fine particulate matter or PM<sub>2.5</sub>, which is an air pollutant with human health consequences.<br><br>


        City-level data (represented as points in the map) for around 1,600 cities in 91 countries from 2008 to 2013 are provided in the <a href="http://www.who.int/phe/health_topics/outdoorair/databases/AAP_database_methods_2014.pdf?ua=1" target="_blank">WHO's Ambient Air Pollution database</a>. These values for cities generally represent annual averaged data from a single or multiple air monitoring stations.<br><br> 

        The national data (represented by the country shading) are from the 2014 <a href="http://www.epi.yale.edu/" target="_blank">Environmental Performance Index (EPI)</a>. Researchers led by <a href="http://myweb.dal.ca/adonkela/main.swf" target="_blank">Aaron van Donkelaar</a> at Dalhousie University used satellite data to estimate ground-level exposures to fine particulate matter (PM<sub>2.5</sub>). These data indicate longer term exposures to PM<sub>2.5</sub> and are based on a three-year rolling average of data from 1998 to 2012. Read more about how these data were developed <a href="http://epi.yale.edu/our-methods/air-quality" target="_blank">here</a>.<br><br>


        <h1><b>ABOUT THE ENVIRONMENTAL PERFORMANCE INDEX (EPI)</b></h1><br>
        The <a href="http://www.epi.yale.edu/" target="_blank">Environmental Performance Index</a> is a biennial global ranking of how well countries perform on high-priority environmental issues. It is a joint project of the <a href="http://envirocenter.yale.edu/" target="_blank">Yale Center for Environmental Law & Policy</a> and the <a href="http://ciesin.columbia.edu/" target="_blank">Center for International Earth Science Information Network</a> at The Earth Institute, Columbia University. 
        <br><br><br>
        <span>Created by <a href="http://spinsomewebs.com/" target="_blank">Pedro Cunha</a> and <a href="http://www.dmitrypavluk.com" target="_blank">Dmitry Pavluk</a> using CartoDB <br>with help from <a href="https://twitter.colorsm/andrewxhill" target="_blank">Andrew Hill</a>, Anna Young, and Diego Torres Quintanilla</span>
      </div></div>
    </div>

    <div id="header_container">
      <div id="header">
      </div>
     </div>     
        

  </body>

   <script type="cartocss/html" id="pops">
   /*Country Styles*/

    #pops{
      polygon-fill: #fff;
      polygon-opacity: 0.9;
      line-color: #FFF;
      line-width: 1;
      line-opacity: 1;
    }

    #pops [ {0} <= 24] {
       polygon-fill: #FED976;
    }
    #pops [ {0} <= 21] {
       polygon-fill: #FEB24C;
    }
    #pops [ {0} <= 18] {
       polygon-fill: #FD8D3C;
    }
    #pops [ {0} <= 15] {
       polygon-fill: #FC4E2A;
    }
    #pops [ {0} <= 12] {
       polygon-fill: #E31A1C;
    }
    #pops [ {0} <= 7] {
       polygon-fill: #B10026;
    }
    #pops [ {0} <= 4] {
       polygon-fill: #8C021F;
    }
    </script>
     
     <script>
          //Formats the columns for us into css
          String.prototype.format = (function (i, safe, arg) {
            function format() {
                var str = this,
                    len = arguments.length + 1;

                for (i = 0; i < len; arg = arguments[i++]) {
                    safe = typeof arg === 'object' ? JSON.stringify(arg) : arg;
                    str = str.replace(RegExp('\\{' + (i - 1) + '\\}', 'g'), safe);
                }
                return str;
            }

            return format;
            
        })();


      // create layer selector
    function main() {
        var map = new L.Map('map', { 
          zoomControl: true,
          legend:true,
          center: [43, 0],
          zoom: 2,
          scrollWheelZoom: true,
          searchControl: true
        });

        // create our layers
        cartodb.createLayer(map, {
          user_name: 'annasyoung',
          type: 'cartodb',
          sublayers: [{
            sql: "SELECT * FROM bathymetry_layers",
            cartocss: "#bathymetry_layers{ polygon-fill: #598cdb;polygon-opacity: 0.2;line-color: #FFF;line-width: 0;line-opacity: 1;}"
            },{
            sql: "SELECT * FROM pops",
            cartocss: $('#pops').html().format('total_score'),
            interactivity: "cartodb_id, the_geom, country, total_score"
            }]

        }).done(function(layer) {
          // add the layers to our map 
          map.addLayer(layer);
          sublayer_country = layer.getSubLayer(1);
          sublayer_country.setInteraction(true);

          
          
          //Make Tool-tip follow the mouse.
          var event = function(e){
                  $('#tool-tip').css({
                     left:  e.pageX,
                     top:   e.pageY
                  });
              };

          var col1 = "total_score";
          //Retrieve data to the tooltip on countries
          sublayer_country.on('featureOver', function(e, pos, latlng, data) {
            $('#tool-tip').html('<p>'  +data['country']+'<br>'+ data[col1] + '&mu;g/m<sup>3</sup></p>');
            $(document).bind('mousemove', event);
            $('#tool-tip').show();
            
          });
            sublayer_country.on('featureOut', function(e, pos, latlng, data) {
           //Make the tooltip go away when off countries
            $('#tool-tip').hide();
            $(document).unbind('mousemove', event, false);
          });

    });
  }

      
      window.onload = main;

       //have the info tab slide out
      $('#slide_out_info').tabSlideOut({
        tabHandle: '.handle',                     //class of the element that will become your tab
        //Optionally can be set using css
        height: '110px',                     //height of tab image           //Optionally can be set using css
        width: '30px',                       //width of tab image            //Optionally can be set using css
        tabLocation: 'right',                      //side of screen where tab lives, top, right, bottom, or left
        speed: 400,                               //speed of animation
        action: 'click',                  //options: true makes it stick(fixed position) on scroll
      });

    </script>

</script>
</html>