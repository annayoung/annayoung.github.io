
<!DOCTYPE html>
<html>
  <head>
     <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
     <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
     <link href='iframe_style.css' rel='stylesheet' type='text/css'>
     <script type="text/javascript" src="jquery.js"></script>
  </head>

  <body>
    
    <div id="map"></div>
    <div id="tool-tip"></div>
    <div id="preferences">
    </div>
    
  </body>

   <script type="cartocss/html" id="coloring">
   /* -54 to 27 */
    #coloring{
      polygon-fill: #FFFFB2;
      polygon-opacity: 1;
    }
    #coloring [ {0} <= 27] {
       polygon-fill: #02820B;
    }
    #coloring [ {0} <= 22] {
       polygon-fill: #158202;
    }
    #coloring [ {0} <= 17] {
       polygon-fill: #328102;
    }
    #coloring [ {0} <= 12] {
       polygon-fill: #4E8102;
    }
    #coloring [ {0} <= 7] {
       polygon-fill: #6A8002;
    }
    #coloring [ {0} <= 2] {
       polygon-fill: #7F7802;
    }
    #coloring [ {0} <= -3] {
       polygon-fill: #7E5C02;
    }
    #coloring [ {0} <= -8] {
       polygon-fill: #7E3F02;
    }
    #coloring [ {0} <= -13] {
       polygon-fill: #7D2302;
    }
    #coloring [ {0} <= -18] {
       polygon-fill: #7C0703;
    }
    </script>

    <script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script> 
     
     <script>
          //Formats the columns for us into css
          String.prototype.format = (function (i, safe, arg) {
            function format() {
                var str = this,
                    len = arguments.length + 1;
                for (i = 0; i < len; arg = arguments[i++]) {
                    safe = typeof arg === 'object' ? JSON.stringify(arg) : arg;
                    str = str.replace(RegExp('\\{' + (i - 1) + '\\}', 'g'), safe);
                }
                return str;
            }
            return format;
            
        })();
    function main() {

      var population_rank = window.parent.document.querySelector('input[name="population"]:checked').value;
      var pesticide_rank = window.parent.document.querySelector('input[name="pesticides"]:checked').value;
      var rent_rank = window.parent.document.querySelector('input[name="median_rent"]:checked').value;

      var loader = new cdb.geo.ui.TilesLoader({ template: function(){ return '<div class="loader"></div>' } });

        var map = new L.Map('map', { 
          zoomControl: false,
          legend:true,
          center: [40, -98],
          zoom: 3.8,
          scrollWheelZoom: false,
          searchControl: false
        });
        new L.Control.Zoom({ position: 'bottomright' }).addTo(map);

        var updateMap = function(sublayer_county) {

          var equation = "(" 
            +"CASE WHEN " + pesticide_rank + " = 0 THEN 0 ELSE " 
            +"((pesticide_score-" + pesticide_rank + ")* "
            +"(CASE WHEN (pesticide_score-" + pesticide_rank + ") < 0 THEN 2 "
            +"WHEN (pesticide_score-" + pesticide_rank + ") >= 0 THEN 1 "
            +"END)) END + "
            +"CASE WHEN " + population_rank + " = 0 THEN 0 ELSE " 
            +"((population_score-" + population_rank + ")* "
            +"(CASE WHEN (population_score-" + population_rank + ") < 0 THEN 2 "
            +"WHEN (population_score-" + population_rank + ") >= 0 THEN 1 "
            +"END)) END + " 
            +"CASE WHEN " + rent_rank + " = 0 THEN 0 ELSE " 
            + "((rent_score-" + rent_rank + ")* "
            +"(CASE WHEN (rent_score-" + rent_rank + ") < 0 THEN 2 "
            +"WHEN (rent_score-" + rent_rank + ") >= 0 THEN 1 END)) END)";

          var sql = 
            "SELECT cartodb_id, the_geom_webmercator, name, state_name, population2014, kg, median_cash_rent, pesticide_score, population_score, rent_score, \
              (" + equation + ") as total_score \
              FROM \
            (SELECT county_shapes.cartodb_id, county_shapes.the_geom_webmercator, name, state_name, population2014, kg, median_cash_rent,  \
            CASE \
              WHEN kg <= 10 THEN 10 \
              WHEN kg <= 50 and kg > 10 THEN 9 \
              WHEN kg <= 100 and kg > 50 THEN 8 \
              WHEN kg <= 1000 and kg > 100 THEN 7 \
              WHEN kg <= 5000 and kg > 1000 THEN 6 \
              WHEN kg <= 10000 and kg > 5000 THEN 5 \
              WHEN kg <= 50000 and kg > 10000 THEN 4 \
              WHEN kg <= 100000 and kg > 50000 THEN 3 \
              WHEN kg <= 350000 and kg > 100000 THEN 2 \
              WHEN kg > 350000 THEN 1 \
            END as pesticide_score, \
            CASE \
              WHEN population2014 >= 2000000 THEN 10 \
              WHEN population2014 >= 900000 and population2014 < 2000000 THEN 9 \
              WHEN population2014 >= 600000 and population2014 < 900000 THEN 8 \
              WHEN population2014 >= 400000 and population2014 < 600000 THEN 7 \
              WHEN population2014 >= 200000 and population2014 < 400000 THEN 6 \
              WHEN population2014 >= 100000 and population2014 < 200000 THEN 5 \
              WHEN population2014 >= 50000 and population2014 < 100000 THEN 4 \
              WHEN population2014 >= 15000 and population2014 < 50000 THEN 3 \
              WHEN population2014 >= 5000 and population2014 < 15000 THEN 2 \
              WHEN population2014 >= 0 and population2014 < 5000 THEN 1 \
            END as population_score, \
            CASE \
              WHEN median_cash_rent <= 200 THEN 10 \
              WHEN median_cash_rent <= 400 and median_cash_rent > 200 THEN 9 \
              WHEN median_cash_rent <= 600 and median_cash_rent > 400 THEN 8 \
              WHEN median_cash_rent <= 800 and median_cash_rent > 600 THEN 7 \
              WHEN median_cash_rent <= 1000 and median_cash_rent > 800 THEN 6 \
              WHEN median_cash_rent <= 1200 and median_cash_rent > 1000 THEN 5 \
              WHEN median_cash_rent <= 1400 and median_cash_rent > 1200 THEN 4 \
              WHEN median_cash_rent <= 1600 and median_cash_rent > 1400 THEN 3 \
              WHEN median_cash_rent <= 1800 and median_cash_rent > 1600 THEN 2 \
              WHEN median_cash_rent <= 2001 and median_cash_rent > 1800 THEN 1 \
            END as rent_score \
            FROM county_shapes, county_size, glyphosate, rent \
            WHERE county_shapes.state_name=county_size.State \
            AND CONCAT(county_shapes.name,' County')=county_size.County \
            AND glyphosate.state_fips_code=county_shapes.state_fips \
            AND glyphosate.county_fips_code=county_shapes.cnty_fips \
            AND rent.state_string=county_shapes.state_name \
            AND rent.area_name=county_shapes.name) as r \
            ";
            sublayer_county.setSQL(sql);

            // update color scale to be over max range
            var min = (1 - pesticide_rank)*2*Math.min(1, pesticide_rank) + (1 - population_rank)*2*Math.min(1, population_rank) + (1 - rent_rank)*2*Math.min(1, rent_rank);
            var max = (10 - pesticide_rank)*Math.min(1, pesticide_rank) + (10 - population_rank)*Math.min(1, population_rank) + (10 - rent_rank)*Math.min(1, rent_rank);
            var interval = (max - min)/10;

            var css = "#coloring [ total_score <= " + max + "] { \
               polygon-fill: #02820B; \
            } \
            #coloring [ total_score <= " + (max - interval) + "] { \
               polygon-fill: #158202; \
            } \
            #coloring [ total_score <= " + (max - interval*2) + "] { \
               polygon-fill: #328102; \
            } \
            #coloring [ total_score <= " + (max - interval*3) + "] { \
               polygon-fill: #4E8102; \
            } \
            #coloring [ total_score <= " + (max - interval*4) + "] { \
               polygon-fill: #6A8002; \
            } \
            #coloring [ total_score <= " + (max - interval*5) + "] { \
               polygon-fill: #7F7802; \
            } \
            #coloring [ total_score <= " + (max - interval*6) + "] { \
               polygon-fill: #7E5C02; \
            } \
            #coloring [ total_score <= " + (max - interval*7) + "] { \
               polygon-fill: #7E3F02; \
            } \
            #coloring [ total_score <= " + (max - interval*8) + "] { \
               polygon-fill: #7D2302; \
            } \
            #coloring [ total_score <= " + (max - interval*9) + "] { \
               polygon-fill: #7C0703; \
            }"
            
            sublayer_county.setCartoCSS(css);

        };

        // create our layers
        cartodb.createLayer(map, {
          user_name: 'briannaloo',
          type: 'cartodb',
          sublayers: [{
            sql: "SELECT county_shapes.cartodb_id, county_shapes.the_geom_webmercator, county_shapes.name, cnty_fips, state_name, county_size.State, county_size.County, state_fips, population2014, glyphosate.county_fips_code, glyphosate.state_fips_code, kg, rent.median_cash_rent, rent.state_string, rent.area_name FROM county_shapes, county_size, glyphosate, rent",
            cartocss: $('#coloring').html().format('total_score'),
            interactivity: "cartodb_id, the_geom_webmercator, name, state_name, population2014, kg, median_cash_rent"
            }]
        }).done(function(layer) {
          function addLoader(layer) {
            layer.bind('loading', function() { loader.show() });
            layer.bind('load',  function() { loader.hide(); });
          }
          console.log("loaded data");
          // add the layers to our map 
          map.addLayer(layer);
          sublayer_county = layer.getSubLayer(0);
          sublayer_county.setInteraction(true);
          updateMap(sublayer_county);

          // update preferences         
          $('.button', window.parent.document).click(function() {
            population_rank = window.parent.document.querySelector('input[name="population"]:checked').value;
            pesticide_rank = window.parent.document.querySelector('input[name="pesticides"]:checked').value;
            rent_rank = window.parent.document.querySelector('input[name="median_rent"]:checked').value;

            updateMap(sublayer_county);
          });

          // tool tip
          cdb.vis.Vis.addInfowindow(map, layer.getSubLayer(0), ['name']);

          var event = function(e){
              $('#tool-tip').css({
                 left:  e.pageX,
                 top:   e.pageY
              });
          };
          sublayer_county.on('featureOver', function(e, pos, data) {

            console.log("in");

            $('#tool-tip').html('<p>'  +data[state_name]+'<br>'+ data[name] + '&mu;g/m<sup>3</sup></p>');
            $(document).bind('mousemove', event);
            $('#tool-tip').show();
            
          });
            sublayer_county.on('featureOut', function(e, pos, latlng, data) {
           //Make the tooltip go away when off countries
            $('#tool-tip').hide();
            console.log("out")
            $(document).unbind('mousemove', event, false);
          });

      

          
    });
  }
      window.onload = main;
  
    </script>

</script>
</html>